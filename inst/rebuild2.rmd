---
title: "pKa Analysis of %phfluor%"
header-includes: \pagenumbering{gobble}
output:
  pdf_document: default
html_document:
  df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```
  
```{r data, echo=FALSE}
library(foam)
library(dplyr)
library(knitr)
library(ggplot2)
library(gridExtra)
library(ggthemes)
library(kableExtra)
library(pKa)

# Set Outlier Cutoff
OLCUT <- 7

# Ensure directory is correct
dir <- normalizePath("%path%", winslash = "/")  # This is now correct

if (!dir.exists(dir)) {
  message("Creating missing directory: ", dir)
  dir.create(dir, recursive = TRUE, showWarnings = FALSE)
}

# Find valid files
files <- list.files(dir, pattern = '(asyr|xflr)$', full.names = TRUE)

if (length(files) == 0) {
  stop("No valid data files found in the directory!")
}

# Debugging Output
print(paste("Working directory:", dir))
print(paste("Files found:", length(files)))

# Process files
objs <- purrr::map(files, foam::new)

# Extract metadata
meta <- purrr::map_df(objs, function(u) {
  tibble(
    file = normalizePath(u$file, winslash = "/"),
    Instrument = u$Inst,
    Lot = paste0(u$type, u$lot),
    Serial = u$sn,
    SWVersion = u$software$SWVersion
  )
})

# Generate titration data
data0 <- get_titration_data(objs, meta$file)

if (is.null(data0) || nrow(data0) == 0) {
  stop("Titration data could not be generated!")
}

data <- filter(data0, modZ <= OLCUT)
outliers <- filter(data0, modZ > OLCUT)

# Ensure CSV file can be written
csv_path <- file.path(dir, "data.csv")

print(paste("Attempting to write CSV to:", csv_path))
if (file.exists(csv_path)) {
  file.remove(csv_path)  # Prevents locked file issues
}

write.csv(data0, file.path("%path%", "data.csv"), row.names = FALSE)

if (!file.exists(csv_path)) {
  stop("CSV file was not created successfully!")
}
